{"version":3,"file":"hooks.server-xRc1dAqo.js","sources":["../../../.svelte-kit/adapter-node/chunks/hooks.server.js"],"sourcesContent":["import cron from \"node-cron\";\nimport { D as DataService } from \"./DataService.js\";\nimport * as puppeteer from \"puppeteer\";\nimport { e as error } from \"./index.js\";\nclass RugbyNLService {\n  async ReadSeasonData() {\n    var isWin = process.platform === \"win32\";\n    let browser = isWin ? await puppeteer.launch() : await puppeteer.launch({\n      executablePath: \"/usr/bin/chromium-browser\",\n      headless: true,\n      args: [\"--no-sandbox\", \"--disable-setuid-sandbox\"]\n    });\n    let leaguePartials = await this.GetLeaguePartials(browser);\n    await Promise.all(leaguePartials.map((a_item) => this.FillLeagueData(a_item, browser)));\n    browser.close();\n    return leaguePartials;\n  }\n  async GetLeaguePartials(browser) {\n    const page = await browser.newPage();\n    await page.exposeFunction(\"Log\", Log);\n    await page.goto(s_leagueUrl);\n    const mostRecentSeason = await page.evaluate(() => {\n      const container = document.getElementById(\"menu-speelschema\");\n      const linkElement = container.firstElementChild.firstElementChild;\n      return linkElement.href;\n    });\n    await page.goto(mostRecentSeason);\n    const leaguePartials = await page.evaluate(() => {\n      const container = document.getElementsByClassName(\"the-content\").item(0);\n      const accordionElements = [...container.getElementsByClassName(\"accordion-item\")].slice(0, 5);\n      let result = [];\n      for (let accordionElement of accordionElements) {\n        const category = accordionElement.getElementsByClassName(\"accordion-title\")[0].firstChild.textContent;\n        const divisionHeadingElements = accordionElement.querySelectorAll(\"h6.wp-block-heading\");\n        const divisionButtonGroupElements = accordionElement.getElementsByClassName(\"wp-block-buttons\");\n        for (let [index, divisionHeadingElement] of [...divisionHeadingElements].entries()) {\n          const heading = divisionHeadingElement.textContent;\n          const divisionButtonGroupAnchorElements = [...divisionButtonGroupElements[index].querySelectorAll(\"a:not(.has-white-background-color)\")];\n          const partials = divisionButtonGroupAnchorElements.map((a_item) => ({ Name: a_item.textContent, URL: a_item.href, Category: category, Division: heading }));\n          result.push(...partials);\n        }\n      }\n      return result;\n    });\n    console.log(leaguePartials);\n    return leaguePartials;\n  }\n  async FillLeagueData(partial, browser) {\n    if (!partial.URL)\n      return;\n    const page = await browser.newPage();\n    await page.exposeFunction(\"ParseDate\", ParseDate);\n    await page.exposeFunction(\"ParseScore\", ParseScore);\n    await page.exposeFunction(\"Log\", Log);\n    await page.goto(partial.URL);\n    partial.Ranking = await this.ReadRankingTable(page);\n    partial.Matches = await this.ReadMatchTable(page);\n  }\n  async ReadMatchTable(page) {\n    return page.evaluate(async () => {\n      const rows = Array.from(document.querySelectorAll(\".results tbody tr\"));\n      const matches = [];\n      let date = /* @__PURE__ */ new Date();\n      for (const row of rows) {\n        const columns = Array.from(row.querySelectorAll(\"td\"));\n        if (columns.length == 1) {\n          date = await ParseDate(columns[0].textContent ?? \"\");\n        } else if (columns.length == 5 && !row.classList.contains(\"header\")) {\n          let parsedScore = await ParseScore(columns[4].textContent);\n          matches.push(\n            {\n              Date: date,\n              Time: columns[0].textContent,\n              Location: columns[1].textContent,\n              HomeTeam: columns[2].textContent,\n              AwayTeam: columns[3].textContent,\n              Score: parsedScore\n            }\n          );\n        }\n      }\n      return matches;\n    });\n  }\n  async ReadRankingTable(page) {\n    return page.evaluate(async () => {\n      const rows = Array.from(document.querySelectorAll(\"#team-ranking tbody tr:not(.header)\"));\n      const rankings = [];\n      for (const row of rows) {\n        const columns = Array.from(row.querySelectorAll(\"td\"));\n        rankings.push(\n          {\n            Rank: parseInt(columns[0].textContent),\n            TeamName: columns[1].textContent,\n            MatchesPlayed: parseInt(columns[2].textContent),\n            Wins: parseInt(columns[3].textContent),\n            Losses: parseInt(columns[4].textContent),\n            Draws: parseInt(columns[5].textContent),\n            CompetitionPoints: parseInt(columns[6].textContent),\n            PointsScored: parseInt(columns[7].textContent),\n            PointsConceded: parseInt(columns[8].textContent),\n            PointsBalance: parseInt(columns[9].textContent)\n          }\n        );\n      }\n      return rankings;\n    });\n  }\n}\nasync function ParseDate(date) {\n  const dateElements = date.split(\" \");\n  const day = parseInt(dateElements[1]);\n  const month = s_dutchMonths.findIndex((val) => val === dateElements[2]);\n  const year = parseInt(dateElements[3]);\n  return new Date(year, month, day);\n}\nasync function ParseScore(score) {\n  let elements = score.split(\" - \");\n  if (elements.length != 2)\n    return null;\n  let result = {\n    HomeTeam: parseInt(elements[0]),\n    AwayTeam: parseInt(elements[1])\n  };\n  return result;\n}\nfunction Log(...params) {\n  console.log(params);\n}\nconst s_leagueUrl = \"https://rugby.nl/competitie/speelschema/\";\nconst s_dutchMonths = [\n  \"januari\",\n  \"februari\",\n  \"maart\",\n  \"april\",\n  \"mei\",\n  \"juni\",\n  \"juli\",\n  \"augustus\",\n  \"september\",\n  \"oktober\",\n  \"november\",\n  \"december\"\n];\nlet cronStarted = false;\nasync function runJob() {\n  try {\n    console.log(\"CRON job started\");\n    let rugbyNL = new RugbyNLService();\n    let leagues = await rugbyNL.ReadSeasonData();\n    DataService.UpdateLeagueData(leagues);\n    console.log(\"CRON job finished\");\n  } catch (e) {\n    console.error(\"CRON job error:\", e);\n  }\n}\nconsole.log(\"✅ hooks.server.ts loaded\");\nif (!cronStarted) {\n  runJob();\n  cron.schedule(\"* */12 * * *\", () => {\n    console.log(\"[CRON] Running match crawler\");\n    runJob();\n  });\n  cronStarted = true;\n}\nconst handle = async ({ event, resolve }) => {\n  console.log(\"⚡️ Received request:\", event.url.pathname);\n  try {\n    return await resolve(event);\n  } catch (err) {\n    console.error(\"❌ Request error:\", err);\n    throw error(500, \"Internal Server Error\");\n  }\n};\nexport {\n  handle\n};\n"],"names":[],"mappings":"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"}