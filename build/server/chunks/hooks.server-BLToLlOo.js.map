{"version":3,"file":"hooks.server-BLToLlOo.js","sources":["../../../.svelte-kit/adapter-node/chunks/hooks.server.js"],"sourcesContent":["import cron from \"node-cron\";\nimport { D as DataService } from \"./DataService.js\";\nimport * as puppeteer from \"puppeteer\";\nimport { e as error } from \"./index.js\";\nclass RugbyNLService {\n  async ReadSeasonData() {\n    let browser = await puppeteer.launch({\n      executablePath: \"/usr/bin/chromium-browser\",\n      headless: true,\n      args: [\"--no-sandbox\", \"--disable-setuid-sandbox\"]\n    });\n    let leagueUrls = await this.GetLeagueUrls(browser);\n    let tables = await Promise.all(leagueUrls.map((a_item) => this.ReadMatchTable(a_item, browser)));\n    browser.close();\n    return tables;\n  }\n  async GetLeagueUrls(browser) {\n    const page = await browser.newPage();\n    await page.goto(s_leagueUrl);\n    const url = await page.evaluate(() => {\n      const container = document.getElementById(\"menu-speelschema\");\n      const linkElement = container.firstElementChild.firstElementChild;\n      return linkElement.href;\n    });\n    await page.goto(url);\n    const leagueUrls = await page.evaluate(() => {\n      const container = document.getElementsByClassName(\"the-content\").item(0);\n      const accordionElements = [...container.getElementsByClassName(\"accordion-item\")].slice(0, 5);\n      const anchorElements = accordionElements.reduce((acc, cur) => [...acc, ...cur.getElementsByTagName(\"a\")], []);\n      return [...anchorElements].map((a_item) => a_item.href).filter((a_item) => a_item.length > 0);\n    });\n    console.log(leagueUrls);\n    return leagueUrls;\n  }\n  async ReadMatchTable(url, browser) {\n    const page = await browser.newPage();\n    await page.exposeFunction(\"ParseDate\", ParseDate);\n    await page.exposeFunction(\"ParseScore\", ParseScore);\n    await page.exposeFunction(\"Log\", Log);\n    await page.goto(url);\n    const tableData = await page.evaluate(async (url2) => {\n      const result = {\n        Url: url2,\n        Matches: []\n      };\n      const rows = Array.from(document.querySelectorAll(\".results tbody tr\"));\n      let date = /* @__PURE__ */ new Date();\n      for (const row of rows) {\n        const columns = Array.from(row.querySelectorAll(\"td\"));\n        if (columns.length == 1) {\n          date = await ParseDate(columns[0].textContent ?? \"\");\n        } else if (columns.length == 5 && !row.classList.contains(\"header\")) {\n          let parsedScore = await ParseScore(columns[4].textContent);\n          result.Matches.push(\n            {\n              Date: date,\n              Time: columns[0].textContent,\n              Location: columns[1].textContent,\n              HomeTeam: columns[2].textContent,\n              AwayTeam: columns[3].textContent,\n              Score: parsedScore\n            }\n          );\n        }\n      }\n      return result;\n    }, url);\n    return tableData;\n  }\n}\nasync function ParseDate(date) {\n  const dateElements = date.split(\" \");\n  const day = parseInt(dateElements[1]);\n  const month = s_dutchMonths.findIndex((val) => val === dateElements[2]);\n  const year = parseInt(dateElements[3]);\n  return new Date(year, month, day);\n}\nasync function ParseScore(score) {\n  let elements = score.split(\" - \");\n  if (elements.length != 2)\n    return null;\n  let result = {\n    HomeTeam: parseInt(elements[0]),\n    AwayTeam: parseInt(elements[1])\n  };\n  return result;\n}\nfunction Log(...params) {\n  console.log(params);\n}\nconst s_leagueUrl = \"https://rugby.nl/competitie/speelschema/\";\nconst s_dutchMonths = [\n  \"januari\",\n  \"februari\",\n  \"maart\",\n  \"april\",\n  \"mei\",\n  \"juni\",\n  \"juli\",\n  \"augustus\",\n  \"september\",\n  \"oktober\",\n  \"november\",\n  \"december\"\n];\nlet cronStarted = false;\nasync function runJob() {\n  try {\n    console.log(\"CRON job started\");\n    let rugbyNL = new RugbyNLService();\n    let matchTables = await rugbyNL.ReadSeasonData();\n    DataService.UpdateMatchData(matchTables);\n    console.log(\"CRON job finished\");\n  } catch (e) {\n    console.error(\"CRON job error:\", e);\n  }\n}\nconsole.log(\"✅ hooks.server.ts loaded\");\nif (!cronStarted) {\n  runJob();\n  cron.schedule(\"* */12 * * *\", () => {\n    console.log(\"[CRON] Running match crawler\");\n    runJob();\n  });\n  cronStarted = true;\n}\nconst handle = async ({ event, resolve }) => {\n  console.log(\"⚡️ Received request:\", event.url.pathname);\n  try {\n    return await resolve(event);\n  } catch (err) {\n    console.error(\"❌ Request error:\", err);\n    throw error(500, \"Internal Server Error\");\n  }\n};\nexport {\n  handle\n};\n"],"names":[],"mappings":"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"}